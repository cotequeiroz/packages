From 823b943b6dc221d72b1b7feafc4439b9c3d3d868 Mon Sep 17 00:00:00 2001
From: Nicola Di Lieto <nicola.dilieto@gmail.com>
Date: Mon, 17 Jun 2019 08:30:00 +0200
Subject: [PATCH] check libcurl https support at configure time

- also removed AC_REVISION as it is redundant
---
 configure    | 16 ++++++++++++----
 configure.ac | 10 ++++++++--
 2 files changed, 20 insertions(+), 6 deletions(-)

diff --git a/configure b/configure
index 1d051a6..8ce7e8a 100755
--- a/configure
+++ b/configure
@@ -1,5 +1,4 @@
 #! /bin/sh
-# From configure.ac v1.0.15.
 # Guess values for system-dependent variables and create Makefiles.
 # Generated by GNU Autoconf 2.69 for uacme 1.0.15.
 #
@@ -2951,7 +2950,6 @@ fi
     ax_enable_debug=$enable_debug
 
 
-
 if test -z "$SED"; then
     # Extract the first word of "sed", so it can be a program name with args.
 set dummy sed; ac_word=$2
@@ -5657,13 +5655,23 @@ $as_echo_n "checking for libcurl >= 7.38.0... " >&6; }
 $as_echo "no" >&6; }
             as_fn_error $? "libcurl not found" "$LINENO" 5
         else
+            { $as_echo "$as_me:${as_lineno-$LINENO}: result: found $version" >&5
+$as_echo "found $version" >&6; }
+            { $as_echo "$as_me:${as_lineno-$LINENO}: checking for libcurl https support" >&5
+$as_echo_n "checking for libcurl https support... " >&6; }
+            https=`$PKGCONFIG --variable=supported_protocols libcurl 2>/dev/null | grep -q HTTPS && echo 1`
+            if test -z "$https"; then
+                { $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
+$as_echo "no" >&6; }
+                as_fn_error $? "libcurl does not support https" "$LINENO" 5
+            fi
+            { $as_echo "$as_me:${as_lineno-$LINENO}: result: yes" >&5
+$as_echo "yes" >&6; }
             addlib=`$PKGCONFIG --libs-only-l libcurl`
             addld=`$PKGCONFIG --libs-only-L libcurl`
             addcflags=`$PKGCONFIG --cflags-only-I libcurl`
             version=`$PKGCONFIG --modversion libcurl`
             curllib=`echo $addld | $SED -e 's/-L//'`
-            { $as_echo "$as_me:${as_lineno-$LINENO}: result: found $version" >&5
-$as_echo "found $version" >&6; }
         fi
     fi
 else
diff --git a/configure.ac b/configure.ac
index 14499f0..faa57cf 100644
--- a/configure.ac
+++ b/configure.ac
@@ -25,7 +25,6 @@ AM_MAINTAINER_MODE([enable])
 AM_SILENT_RULES([yes])
 AX_IS_RELEASE([git-directory])
 AX_CHECK_ENABLE_DEBUG([yes])
-AC_REVISION([m4_esyscmd_s([git describe --always])])
 
 if test -z "$SED"; then
     AC_PATH_PROG([SED], [sed], [not_found],
@@ -71,12 +70,19 @@ if test X"$OPT_LIBCURL" = Xyes; then
             AC_MSG_RESULT([no])
             AC_MSG_ERROR([libcurl not found])
         else
+            AC_MSG_RESULT([found $version])
+            AC_MSG_CHECKING([for libcurl https support])
+            https=`$PKGCONFIG --variable=supported_protocols libcurl 2>/dev/null | grep -q HTTPS && echo 1`
+            if test -z "$https"; then
+                AC_MSG_RESULT([no])
+                AC_MSG_ERROR([libcurl does not support https])
+            fi
+            AC_MSG_RESULT([yes])
             addlib=`$PKGCONFIG --libs-only-l libcurl`
             addld=`$PKGCONFIG --libs-only-L libcurl`
             addcflags=`$PKGCONFIG --cflags-only-I libcurl`
             version=`$PKGCONFIG --modversion libcurl`
             curllib=`echo $addld | $SED -e 's/-L//'`
-            AC_MSG_RESULT([found $version])
         fi
     fi
 else
